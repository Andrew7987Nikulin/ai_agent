<!DOCTYPE html>
<html>
<head>
    <title>GPT-4o Browser Automation</title>
    <base href="/">
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="user-panel">
    {% if current_user.is_authenticated %}
        <div class="user-info">
            üßëüíª {{ current_user.email }} |
            {% if not current_user.totp_secret %}
                <a href="{{ url_for('enable_2fa') }}">–í–∫–ª—é—á–∏—Ç—å 2FA</a> |
            {% endif %}
            <a href="{{ url_for('logout') }}">–í—ã–π—Ç–∏</a>
        </div>
    {% else %}
        <div class="auth-links">
            <a href="{{ url_for('login') }}">–í—Ö–æ–¥</a> |
            <a href="{{ url_for('register') }}">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
        </div>
    {% endif %}
</div>

    <div class="container">
        <h1>Browser Automation Assistant (GPT-4o)</h1>

        {% if current_user.is_authenticated %}
            <div class="control-panel">
                <select id="browserSelect">
                    <option value="chrome">Chrome</option>
                    <option value="firefox">Firefox</option>
                    <option value="edge">Edge</option>
                </select>
                <input type="text" id="promptInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É...">
                <button onclick="execute()">–í—ã–ø–æ–ª–Ω–∏—Ç—å</button>
            </div>
            <div id="result" class="result-area"></div>
        {% else %}
            <div class="auth-required">
                <p>–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è</p>
                <div class="auth-links">
                    <a href="{{ url_for('login') }}" class="auth-btn">–í–æ–π—Ç–∏</a>
                    <a href="{{ url_for('register') }}" class="auth-btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                </div>
            </div>
        {% endif %}
    </div>

    <script>
        async function execute() {
            const prompt = document.getElementById('promptInput').value.trim();
            const browser = document.getElementById('browserSelect').value;
            const resultDiv = document.getElementById('result');

            if (!prompt) {
                resultDiv.innerHTML = '<div class="error">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="loading">üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞...</div>';

            try {
                const response = await fetch('/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ prompt, browser })
                });

                const data = await response.json();

                let html = `<div class="status">${data.status}</div>`;

                if(data.screenshots && data.screenshots.length > 0) {
                    html += '<div class="screenshots-container">';
                    data.screenshots.forEach(img => {
                        html += `
                            <div class="screenshot-item">
                                <img src="/static/${img}" class="screenshot">
                                <div class="caption">${img}</div>
                            </div>`;
                    });
                    html += '</div>';
                }

                if(data.error) {
                    html += `<div class="error">${data.error}</div>`;
                }

                resultDiv.innerHTML = html;

            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        ‚ùå –û—à–∏–±–∫–∞: ${error.message}
                        ${error.response ? await error.response.text() : ''}
                    </div>`;
            }
        }
    </script>
</body>
</html>